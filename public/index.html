<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Agent</title>
  <style>
    body { font-family: system-ui, Arial; margin: 20px; }
    textarea { width: 100%; height: 120px; }
    button { margin-right: 8px; }
    .row { margin-top: 12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
  </style>
  </head>
<body>
  <h1>Voice Agent</h1>
  <div class="row">
    <div>Paste contacts (one per line, Name,Phone):</div>
    <textarea id="contacts"></textarea>
    <button id="upload">Upload Contacts</button>
    <input id="concurrency" type="number" min="1" max="20" value="3" />
    <button id="start">Start</button>
    <button id="stop">Stop</button>
  </div>
  <div class="row">
    <div id="stats"></div>
  </div>
  <div class="row">
    <h3>Follow-ups</h3>
    <table>
      <thead><tr><th>Name</th><th>Phone</th><th>Time</th></tr></thead>
      <tbody id="followups"></tbody>
    </table>
  </div>
  <div class="row">
    <h3>Contacts</h3>
    <table>
      <thead><tr><th>Name</th><th>Phone</th><th>Action</th></tr></thead>
      <tbody id="contactsTable"></tbody>
    </table>
  </div>
  <script>
    const parseContacts = (text) => {
      const lines = text.split(/\n+/).map(x => x.trim()).filter(Boolean)
      const out = []
      for (const l of lines) {
        const parts = l.split(',')
        const name = (parts[0]||'').trim()
        const phone = (parts[1]||'').trim()
        out.push({ name, phone })
      }
      return out
    }
    document.getElementById('upload').onclick = async () => {
      const list = parseContacts(document.getElementById('contacts').value)
      const r = await fetch('/contacts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(list) })
      const j = await r.json()
      alert('Uploaded: ' + j.count)
    }
    document.getElementById('start').onclick = async () => {
      const c = parseInt(document.getElementById('concurrency').value, 10)
      await fetch('/campaign/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ concurrency: c }) })
    }
    document.getElementById('stop').onclick = async () => {
      await fetch('/campaign/stop', { method: 'POST' })
    }
    async function refresh() {
      const r = await fetch('/campaign/status')
      const j = await r.json()
      document.getElementById('stats').textContent = `Status: ${j.status} | Concurrency: ${j.concurrency} | Called: ${j.totals.called} | Answered: ${j.totals.answered} | Failed: ${j.totals.failed} | Queued: ${j.queued} | Active: ${j.active}`
      const tbody = document.getElementById('followups')
      tbody.innerHTML = ''
      for (const x of j.followups) {
        const tr = document.createElement('tr')
        const d = new Date(x.at)
        tr.innerHTML = `<td>${x.name}</td><td>${x.phone}</td><td>${d.toLocaleString()}</td>`
        tbody.appendChild(tr)
      }
      const cr = await fetch('/contacts')
      const cj = await cr.json()
      const ct = document.getElementById('contactsTable')
      ct.innerHTML = ''
      for (const c of cj.items) {
        const tr = document.createElement('tr')
        const btn = `<button data-id="${c.id}" class="press1">Mark Press 1</button>`
        tr.innerHTML = `<td>${c.name}</td><td>${c.phone}</td><td>${btn}</td>`
        ct.appendChild(tr)
      }
      document.querySelectorAll('.press1').forEach(b => {
        b.onclick = async () => {
          const id = b.getAttribute('data-id')
          await fetch(`/simulate/press1/${id}`, { method: 'POST' })
        }
      })
    }
    setInterval(refresh, 1000)
    refresh()
  </script>
</body>
</html>